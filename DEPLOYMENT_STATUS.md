# Deployment Status - PRD Changes

## Completed Steps ‚úÖ

1. ‚úÖ **Supabase CLI Authentication** - Successfully authenticated with access token
2. ‚úÖ **Project Linking** - Linked to project `fobaguhlzpwrzdhyyyje`
3. ‚úÖ **Database Migration** - Applied migration `align_to_prd_schema_partial` successfully
   - Added all new columns to `campanas` table
   - Added all new columns to `personas_contactar` table
   - Created indexes
   - Note: `estado_contacto` remains as TEXT (enum type created but column not converted)
4. ‚úÖ **Edge Functions Deployed** - All 4 functions deployed:
   - `procesar-archivo`
   - `webhook-kapso`
   - `recalcular-distancias`
   - `generar-corte-diario`

## Manual Steps Required üîß

### 1. Configure Supabase Edge Function Secrets

The CLI token doesn't have permissions to set secrets. Set these via Supabase Dashboard:

**Via Dashboard:**
1. Go to: https://supabase.com/dashboard/project/fobaguhlzpwrzdhyyyje/settings/secrets
2. Add/Update these secrets:
   - `KAPSO_API_KEY` = `29ef63b8c7f44b6d258a44288d89f350c3e323bdca8bedae9cb9228f260fbb66`
   - `KAPSO_WEBHOOK_SECRET` = `NEEDS_CONFIGURATION` (placeholder, obtain from Kapso dashboard)

**Via CLI (if permissions are updated):**
```bash
supabase secrets set KAPSO_API_KEY=29ef63b8c7f44b6d258a44288d89f350c3e323bdca8bedae9cb9228f260fbb66
supabase secrets set KAPSO_WEBHOOK_SECRET=NEEDS_CONFIGURATION
```

### 2. Configure Cloudflare Worker Secrets

**Prerequisites:**
- Install/update wrangler: `npm install -g wrangler@latest` or use `npx wrangler`
- Authenticate Cloudflare: Set `CLOUDFLARE_API_TOKEN` environment variable
  - Get token from: https://developers.cloudflare.com/fundamentals/api/get-started/create-token/
  - Required permissions: Account > Cloudflare Workers > Edit

**Set Secrets:**
```bash
cd "/Users/franciscolamberti/Library/Mobile Documents/com~apple~CloudDocs/autobank-dtv"

# Set SUPABASE_URL
echo "https://fobaguhlzpwrzdhyyyje.supabase.co" | npx wrangler secret put SUPABASE_URL

# Set SUPABASE_KEY (service role)
echo "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvYmFndWhsenB3cnpkaHl5eWplIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MTMwOTA5NywiZXhwIjoyMDc2ODg1MDk3fQ.T68hlUzWyrxBDo7wQ6xe_3bVmt7R2QcunfI8lac1pcA" | npx wrangler secret put SUPABASE_KEY

# Set KAPSO_API_KEY
echo "29ef63b8c7f44b6d258a44288d89f350c3e323bdca8bedae9cb9228f260fbb66" | npx wrangler secret put KAPSO_API_KEY

# Set KAPSO_PHONE_NUMBER_ID (placeholder)
echo "NEEDS_CONFIGURATION" | npx wrangler secret put KAPSO_PHONE_NUMBER_ID
```

### 3. Deploy Cloudflare Worker

```bash
cd "/Users/franciscolamberti/Library/Mobile Documents/com~apple~CloudDocs/autobank-dtv"
npx wrangler deploy
```

After deployment, note the Worker URL (e.g., `https://worker-distancias.your-subdomain.workers.dev`)

### 4. Update Frontend Environment Variables

Update `autobank-dtv/.env.local`:

```env
NEXT_PUBLIC_SUPABASE_URL=https://fobaguhlzpwrzdhyyyje.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvYmFndWhsenB3cnpkaHl5eWplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMDkwOTcsImV4cCI6MjA3Njg4NTA5N30.1Vp8L7k-moEM2_1IuuN74oKR3Iwcq1NKtaYFzG0A6NY
NEXT_PUBLIC_WORKER_URL=https://worker-distancias.your-subdomain.workers.dev
```

Replace `your-subdomain.workers.dev` with the actual Worker URL from step 3.

### 5. Configure Kapso Webhook

In the Kapso dashboard:
1. Set webhook URL to: `https://fobaguhlzpwrzdhyyyje.supabase.co/functions/v1/webhook-kapso`
2. Add header: `X-Kapso-Signature` (generated by Kapso using `KAPSO_WEBHOOK_SECRET`)
3. Once `KAPSO_WEBHOOK_SECRET` is obtained, update it in Supabase Edge Function secrets

## Credentials Summary

**Provided & Configured:**
- ‚úÖ Supabase Project URL: `https://fobaguhlzpwrzdhyyyje.supabase.co`
- ‚úÖ Supabase Anon Key: `eyJhbGc...A6NY`
- ‚úÖ Supabase Service Role Key: `eyJhbGc...1pcA`
- ‚úÖ Kapso API Key: `29ef63b8c7f44b6d258a44288d89f350c3e323bdca8bedae9cb9228f260fbb66`

**Missing (Need Configuration):**
- ‚ö†Ô∏è `KAPSO_WEBHOOK_SECRET` - Obtain from Kapso dashboard
- ‚ö†Ô∏è `KAPSO_PHONE_NUMBER_ID` - Default WhatsApp Business Phone Number ID
- ‚ö†Ô∏è Cloudflare API Token - For wrangler authentication

## Next Steps After Manual Configuration

1. Test Edge Functions are accessible
2. Test Worker deployment with a sample request
3. Test frontend can connect to Supabase
4. Run test with sample Excel file upload
5. Verify webhook receives responses from Kapso

## Verification Commands

```bash
# Check Edge Functions are deployed
supabase functions list

# Check Edge Function logs
supabase functions logs procesar-archivo
supabase functions logs webhook-kapso

# Test Worker (after deployment)
curl -X POST https://your-worker.workers.dev \
  -H "Content-Type: application/json" \
  -d '{"campana_id": "test-id", "tipo": "test"}'
```

