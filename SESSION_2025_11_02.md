# Sesión de Trabajo - 2 Noviembre 2025

## Resumen Ejecutivo

Resolución completa del bug BOOT_ERROR en Edge Function `procesar-archivo` + mejoras en normalización telefónica y UI.

**Estado Inicial:** Edge Function crasheaba (503), solo leía 18 de 642 filas, teléfonos con '15' duplicado
**Estado Final:** Función estable (v37), lee 642 filas completas, normalización correcta, UI mejorada

---

## Trabajo Realizado

### 1. Resolución Bug BOOT_ERROR

**Branch:** `fix/edge-procesar-archivo-boot`

**Commits principales:**
1. `82c0ebb` - Skeleton mínimo con boot estable
2. `1d23cab` - Normalización E.164 y deduplicación
3. `0f2dd5f` - Cálculo distancias Pickit
4. `b304103` - Inserción DB en lotes
5. `c988087` - Generación export fuera de rango
6. `b99a11c` - Feature flag VALIDAR_WA
7. `d9e163f` - Hardening y validaciones
8. `082c8b9` - Fix normalización (eliminar '15')
9. `d1ef4f7` - **Merge a main**

**Cambios técnicos:**
- Eliminación de TypeScript interfaces en top-level
- Dynamic imports de xlsx y supabase-js
- Lectura Excel completa con decode_range (no sheet_to_json)
- Normalización E.164 mejorada para Argentina
- Batch inserts (500 filas por chunk)
- Timeouts y abort controllers
- Validaciones de input y límites configurables

### 2. Migration Base de Datos

**Migration:** `allow_null_coords_and_distance`

Permitir valores null en:
- `lat` (latitud)
- `lon` (longitud)
- `distancia_metros`

**Razón:** Algunas filas del Excel no tienen coordenadas válidas, pero deben procesarse igual y marcarse como `fuera_de_rango = true`.

### 3. Detección de Teléfonos Fijos

**Lógica implementada:**
- Columnas 40 (AO - FaxInstalacion) y 41 (AP - Fax2Instalacion): móviles → `tiene_whatsapp = null` (pendiente validación)
- Columnas 38 (AM - TelefonoParticularIns) y 39 (AN - Telefono): fijos → `tiene_whatsapp = false`

**Beneficio:** Identifica automáticamente personas que no se pueden contactar por WhatsApp.

### 4. UI - Badge Cantidad Decos

**Archivo:** `autobank-dtv/app/campanas/[id]/page.tsx`

**Cambio:** Agregado badge azul "X decos" visible cuando `cantidad_decos > 1` en todas las secciones:
- Comprometidos
- In Progress / Contactados
- Fuera de Rango
- Sin WhatsApp
- Atención Especial

### 5. Documentación Actualizada

**Archivos creados/actualizados:**
- ✅ `EDGE_FUNCTION_RESOLUTION.md` - Guía completa de resolución
- ✅ `bug-edgefunction.md` - Actualizado a estado RESUELTO
- ✅ `README.md` - Características finales y formato Excel
- ✅ `PROGRESS.md` - Estado actual del proyecto
- ✅ `SESSION_2025_11_02.md` - Este documento

---

## Resultados de Testing

### Archivo de Prueba: "Listado DTV - Test.xlsx"

**Métricas de procesamiento:**
- Filas totales en Excel: 642
- Personas procesadas (con teléfono): ~640
- Personas deduplicadas finales: 418
- Dentro de rango: 177
- Fuera de rango: 241

**Deduplicación:**
- 642 → 418 personas
- Diferencia (224): mismo cliente con múltiples decos agrupado en uno

### Verificación de Teléfonos

**Ejemplos procesados correctamente:**
- +5491165716179 ✅
- +5491164049143 ✅
- +5491133675791 ✅

**Sin el bug anterior:** +5491115657161**79** (15 duplicado) ❌

---

## Estado del Sistema

### Edge Functions

| Función | Versión | Estado | verify_jwt |
|---------|---------|--------|------------|
| procesar-archivo | v37 | ✅ Working | true* |
| webhook-kapso | v2 | ✅ Working | true |
| recalcular-distancias | v2 | ✅ Working | true |
| generar-corte-diario | v1 | ✅ Working | true |

*Nota: verify_jwt está en true en producción pero config.toml dice false. Funciona porque el frontend usa el Supabase client autenticado.

### Deployments

- **Frontend:** https://autobank-dtv.vercel.app ✅
- **Backend:** Supabase project `fobaguhlzpwrzdhyyyje` ✅
- **Git:** Branch `main` actualizado, pusheado a GitHub ✅

### Base de Datos

- Tablas limpias (0 campañas, 0 personas) - listas para nueva carga
- Schema actualizado con campos nullable
- Índices optimizados
- Migrations aplicadas

---

## Pendientes para Próximas Sesiones

### 1. Cloudflare Worker
- [ ] Obtener credenciales Kapso (API Key, Flow ID, Phone Number ID)
- [ ] Configurar secrets en Cloudflare
- [ ] Deploy worker
- [ ] Actualizar frontend con NEXT_PUBLIC_WORKER_URL

### 2. Testing End-to-End
- [ ] Cargar campaña completa (642 personas)
- [ ] Probar envío en modo DRY_RUN
- [ ] Verificar webhook de respuestas
- [ ] Validar actualización de estados

### 3. Optimizaciones Opcionales
- [ ] Considerar desactivar verify_jwt para procesar-archivo (si hace falta)
- [ ] Activar VALIDAR_WA=true con Kapso configurado
- [ ] Implementar cache de puntos Pickit
- [ ] Paralelizar validaciones WhatsApp

---

## Comandos de Referencia Rápida

### Verificar Edge Function
```bash
curl -X OPTIONS https://fobaguhlzpwrzdhyyyje.supabase.co/functions/v1/procesar-archivo
# Debe devolver: 200
```

### Ver Logs
```bash
# Dashboard: https://supabase.com/dashboard/project/fobaguhlzpwrzdhyyyje/logs/edge-functions
```

### Deploy Edge Function (local)
```bash
cd supabase
supabase functions deploy procesar-archivo --no-verify-jwt
```

### Limpiar DB
```sql
DELETE FROM personas_contactar;
DELETE FROM campanas;
```

### Git Workflow
```bash
git checkout -b feature/nombre
git add -A
git commit -m "descripción"
git push origin feature/nombre
git checkout main
git merge --no-ff feature/nombre
git push origin main
```

---

## Métricas de la Sesión

- **Commits totales:** 15+
- **Edge Function versiones:** v25 → v37 (12 versiones)
- **Archivos modificados:** 5
- **Documentación creada:** 1 archivo nuevo
- **Documentación actualizada:** 4 archivos
- **Bugs resueltos:** 4 críticos
- **Features agregados:** 3 (detección fijos, badge decos, coords nullable)

---

## Notas Técnicas

### Normalización E.164 Argentina

**Formato esperado:** `+549{área}{número}`

**Casos especiales:**
- Buenos Aires: `+54911{8 dígitos}` (área 11 + 9 para móvil)
- Otras provincias: `+549{área 2-4 dígitos}{número 6-8 dígitos}`
- Eliminar '15' si aparece después del código de área
- Eliminar '0' trunk al inicio

### Deduplicación

**Llave primaria:** `nro_cliente`
**Fallback:** `telefono_principal` normalizado

**Resultado:** Personas con múltiples decodificadores se agrupan en un solo registro con:
- `nros_cliente: string[]` - array de todos los números
- `nros_wo: string[]` - array de todas las work orders
- `cantidad_decos: number` - contador

### Detección de Tipo de Teléfono

| Columna Excel | Índice | Tipo | tiene_whatsapp inicial |
|---------------|--------|------|------------------------|
| AO (FaxInstalacion) | 40 | Móvil | null (validar) |
| AP (Fax2Instalacion) | 41 | Móvil | null (validar) |
| AM (TelefonoParticularIns) | 38 | Fijo | false |
| AN (Telefono) | 39 | Fijo | false |

---

## Conclusión

El sistema está **100% funcional** para procesamiento de archivos Excel. La Edge Function `procesar-archivo` ahora:
- ✅ Arranca de forma estable (sin BOOT_ERROR)
- ✅ Lee archivos Excel completos (642 filas)
- ✅ Normaliza teléfonos correctamente a E.164
- ✅ Detecta teléfonos fijos vs móviles
- ✅ Deduplica por cliente y teléfono
- ✅ Calcula distancias Haversine
- ✅ Inserta en DB con manejo de errores
- ✅ Genera exports automáticos
- ✅ Maneja filas sin coordenadas

**Próximo hito:** Integración con Kapso y envío real de mensajes WhatsApp.

